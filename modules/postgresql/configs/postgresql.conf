# PostgreSQL Configuration for Advanced Backup Features
# Custom configuration for homelab PostgreSQL with pg_cron and WAL archiving

# Basic Connection Settings
listen_addresses = '*'
port = 5432
max_connections = 100

# Memory Settings (optimized for 512MB container)
shared_buffers = 128MB
effective_cache_size = 384MB
maintenance_work_mem = 64MB
work_mem = 4MB

# WAL (Write-Ahead Logging) Settings for Backup
wal_level = replica                    # Enable WAL archiving for backups
max_wal_size = 1GB
min_wal_size = 80MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB

# Archive Settings for Incremental Backups
archive_mode = on
archive_command = 'pgbackrest --stanza=homelab archive-push %p'
archive_timeout = 60                   # Force WAL switch every minute

# Hot Standby Settings (for future read replicas)
hot_standby = on
max_wal_senders = 3
wal_keep_size = 256MB

# Logging Settings
log_destination = 'stderr'
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000      # Log slow queries > 1 second
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on

# Performance Settings
random_page_cost = 1.1                 # SSD-optimized
effective_io_concurrency = 200         # SSD-optimized
default_statistics_target = 100

# Extensions
shared_preload_libraries = 'pg_cron'   # Enable pg_cron extension

# pg_cron Settings
cron.database_name = 'homelab'          # Database where pg_cron jobs run
cron.log_statement = on                 # Log cron job statements
cron.log_run = on                       # Log job execution

# Backup-related Settings
full_page_writes = on                   # Required for consistent backups
wal_compression = on                    # Compress WAL files
wal_init_zero = off                     # Don't zero-fill new WAL files (faster on SSDs)
wal_recycle = off                       # Don't recycle WAL files (better for SSDs)